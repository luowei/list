<!DOCTYPE html> <html lang="en"> <head> <meta charset="UTF-8"> <title>知不知</title> <meta name="viewport" content="width=device-width, initial-scale=1"> <meta name="theme-color" content="#157878"> <meta name="baidu-site-verification" content="" /> <meta name="apple-itunes-app" content="app-id=1227288468, app-argument=https://luowei.github.io/list/docs/linux/2016-12-13-ssh%E9%9A%A7%E9%81%93%E3%80%81%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91%E5%8F%8A%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F.html"> <link rel="stylesheet" href="https://luowei.github.io/list/assets/css/normalize.css"> <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'> <link rel="stylesheet" href="https://luowei.github.io/list/assets/css/cayman.css"> </head> <body> <section class="page-header"> <h1 class="project-name">知不知</h1> <h2 class="project-tagline"><a style="color:#ffffff;" href="http://luowei.github.io/list">知不知</a> 是一个代码爱好者的技术知识分享部落格。</h2> <a href="http://wodedata.com" target="_blank" class="btn">wodedata</a> <a href="https://luowei.github.io/list" class="btn">home</a> <a href="http://app.wodedata.com" target="_blank" class="btn">APP作品</a> </section> <section class="main-content"> <!-- 标题 --> <h2>ssh隧道、端口转发及内网穿透</h2> <!-- Google Ads --> <script async="" src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <p><ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-8760692904992206" data-ad-slot="2948937366"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script></p> <h2 id="ssh相关知识点概要">ssh相关知识点概要</h2> <ul> <li>SSH是一种安全的传输协议，目前最多的主要是用于连接服务器，除了这个之外它的隧道转发功能也是非常强大有用的。</li> <li> <p>下面介绍一下三个非常强大的命令：</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> ssh -C -f -N -g -L listen_port:DST_Host:DST_port user@Tunnel_Host 
 ssh -C -f -N -g -R listen_port:DST_Host:DST_port user@Tunnel_Host 
 ssh -C -f -N -g -D listen_port user@Tunnel_Host
</code></pre></div> </div> <ul> <li>参数说明： <ul> <li><code class="highlighter-rouge">-f</code> Fork into background after authentication. 后台认证用户/密码，通常和-N连用，不用登录到远程主机。</li> <li><code class="highlighter-rouge">-L port:host:hostport</code>.将本地机(客户机)的某个端口转发到远端指定机器的指定端口. 工作原理是本地机器上分配了一个 socket 侦听 port 端口, 一旦这个端口上有了连接, 该连接就经过安全通道转发出去, 同时远程主机和 host 的 hostport 端口建立连接. 可以在配置文件中指定端口的转发. 只有 root 才能转发特权端口. IPv6 地址用另一种格式说明: <code class="highlighter-rouge">port/host/hostport</code>。</li> <li><code class="highlighter-rouge">-R port:host:hostport</code>.将远程主机(服务器)的某个端口转发到本地端指定机器的指定端口. 工作原理是远程主机上分配了一个 socket 侦听 port 端口, 一旦这个端口上有了连接, 该连接就经过安全通道转向出去, 同时本地主机和 host 的 hostport 端口建立连接. 可以在配置文件中指定端口的转发. 只有用 root 登录远程主机才能转发特权端口. IPv6 地址用另一种格式说明: <code class="highlighter-rouge">port/host/hostport</code>。</li> <li><code class="highlighter-rouge">-D port</code>.指定一个本地机器 “动态的’’ 应用程序端口转发. 工作原理是本地机器上分配了一个 socket 侦听 port 端口, 一旦这个端口上有了连接, 该连接就经过安全通道转发出去, 根据应用程序的协议可以判断出远程主机将和哪里连接. 目前支持 SOCKS4 协议, 将充当 SOCKS4 服务器. 只有 root 才能转发特权端口. 可以在配置文件中指定动态端口的转发。</li> <li><code class="highlighter-rouge">-C</code> Enable compression. 压缩数据传输。</li> <li><code class="highlighter-rouge">-N</code> Do not execute a shell or command. 不执行脚本或命令，通常与-f连用。</li> <li><code class="highlighter-rouge">-g</code> Allow remote hosts to connect to forwarded ports. 在-L/-R/-D参数中，允许远程主机连接到建立的转发的端口，如果不加这个参数，只允许本地主机建立连接。注：而这个参数我在实践中似乎始终不起作用。</li> </ul> </li> </ul> </li> </ul> <h2 id="建立ssh隧道案例">建立SSH隧道案例</h2> <ul> <li> <p>网络结构说明： <img src="http://ww1.sinaimg.cn/large/680dfa44jw1fapifoe3ccj20dw0a3mxv.jpg" alt="网络拓扑图" /></p> <blockquote> <ol> <li>需要访问234.234.234.234的FTP服务，也就是端口21</li> <li>中间服务器是123.123.123.123</li> </ol> </blockquote> </li> </ul> <h3 id="建立本地ssh隧道">建立本地SSH隧道</h3> <ul> <li>即要实现绕过公司防火墙，访问c某网站服务器。需要在公司内自己的机器上使用如下命令配置来建立一个本地的SSH隧道：</li> </ul> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1. ssh -N -f -L 2121:234.234.234.234:21 123.123.123.123
2. ftp localhost:2121 # 现在访问本地2121端口，就能连接234.234.234.234的21端口了
</code></pre></div></div> <ul> <li>参考说明： <ul> <li>-N 告诉SSH客户端，这个连接不需要执行任何命令。仅仅做端口转发</li> <li>-f 告诉SSH客户端在后台运行</li> <li>-L 做本地映射端口，被冒号分割的三个部分含义分别是 <ul> <li>需要使用的本地端口号</li> <li>需要访问的目标机器IP地址（IP: 234.234.234.234）</li> <li>需要访问的目标机器端口（端口: 21)</li> <li>其中中间服务器是123.123.123.123，需要访问的FTP服务器是234.234.234.234，端口为21</li> <li><code class="highlighter-rouge">-L X:Y:Z</code>的含义是，将IP为Y的机器的Z端口通过中间服务器映射到本地机器的X端口。</li> </ul> </li> <li>最后一个参数是我们用来建立隧道的中间机器的IP地址(IP: 123.123.123.123)</li> </ul> </li> </ul> <h3 id="建立远程ssh隧道">建立远程SSH隧道</h3> <ul> <li>即要实现在IP是123.123.123.123的机器上用命令：<code class="highlighter-rouge">ssh -p 2222 localhost</code>就可以登陆公司的IP是192.168.0.100的机器。则需要在公司内自己的机器上使用以下命令来建立一个远程SSH隧道：</li> </ul> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh -N -f -R 2222:127.0.0.1:22 123.123.123.123
</code></pre></div></div> <ul> <li>参考说明： <ul> <li>-N，-f 这两个参数上面已经在本地SSH隧道中说明过了</li> <li>-R。该参数的三个部分的含义分别是: <ul> <li>远程机器使用的端口（2222）</li> <li>需要映射的内部机器的IP地址(127.0.0.1)</li> <li>需要映射的内部机器的端口(22)</li> <li>其中需要访问内部机器的远程机器的IP地址（这里是123.123.123.123）</li> <li>这里 <code class="highlighter-rouge">-R X:Y:Z</code> 就是把我们内部的Y机器的Z端口映射到远程机器的X端口上</li> </ul> </li> </ul> </li> </ul> <h3 id="通过ssh隧道建立socks服务器">通过SSH隧道建立SOCKS服务器</h3> <p>如果需要借助一台中间服务器访问很多资源，一个个映射显然不是办法。这就要用到SSH客户端为我们提供了通过SSH隧道建立SOCKS服务器(动态绑定)的功能。</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1. ssh -N -f -D 1080 123.123.123 # 将端口绑定在127.0.0.1上
2. ssh -N -f -D 0.0.0.0:1080 123.123.123.123 # 将端口绑定在0.0.0.0上
</code></pre></div></div> <ul> <li>使用场景,假设X网络（192.168.18.0/24）有主机A（192.168.18.100）,Y网络（192.168.2.0/24）有主机B（192.168.2.100）和主机C（192.168.2.101），已知主机A可以连接主机B，但无法连接主机C。</li> </ul> <p>在主机A执行</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh -D localhost:8080 root@192.168.2.100
</code></pre></div></div> <p>然后主机A上的应用程序就可以通过</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SOCKS5 localhost:8080
</code></pre></div></div> <p>访问主机C上的服务。</p> <h3 id="建立ssh隧道的几个技巧">建立SSH隧道的几个技巧</h3> <ul> <li> <p><strong>自动重连</strong>。隧道可能因为某些原因断开，例如：机器重启，长时间没有数据通信而被路由器切断等等。因此我们可以用程序控制隧道的重新连接，例如一个简单的循环或者使用 <a href="http://cr.yp.to/daemontools.html">djb’s daemontools</a> . 不管用哪种方法，重连时都应避免因输入密码而卡死程序。关于如何安全的避免输入密码的方法，参考<a href="http://blog.jianingy.com/node/73">如何实现安全的免密码ssh登录</a> 。这里请注意，如果通过其他程序控制隧道连接，应当避免将SSH客户端放到后台执行，也就是去掉-f参数。</p> </li> <li> <p><strong>保持长时间连接</strong>。有些路由器会把长时间没有通信的连接断开。SSH客户端的TCPKeepAlive选项可以避免这个问题的发生，默认情况下它是被开启的。如果它被关闭了，可以在ssh的命令上加上-o TCPKeepAlive=yes来开启。另一种方法是，去掉-N参数，加入一个定期能产生输出的命令。例如: top或者vmstat。下面给出一个这种方法的例子：<code class="highlighter-rouge">ssh -R 2222:localhost:22 123.123.123.123 "vmstat 30"</code>。</p> </li> <li> <p><strong>检查隧道状态</strong>。有些时候隧道会因为一些原因通信不畅而卡死，例如：由于传输数据量太大，被路由器带入stalled状态。这种时候，往往SSH客户端并不退出，而是卡死在那里。一种应对方法是，使用SSH客户端的ServerAliveInterval和ServerAliveCountMax选项。 ServerAliveInterval会在隧道无通信后的一段设置好的时间后发送一个请求给服务器要求服务器响应。如果服务器在 ServerAliveCountMax次请求后都没能响应，那么SSH客户端就自动断开连接并退出，将控制权交给你的监控程序。这两个选项的设置方法分别是在ssh时加入-o ServerAliveInterval=n和-o ServerAliveCountMax=m。其中n, m可以自行定义。</p> </li> <li> <p><strong>将端口绑定到外部地址上</strong>。使用上面的方法，映射的端口只能绑定在127.0.0.1这个接口上。也就是说，只能被本机自己访问到。如何才能让其他机器访问这个端口呢？我们可以把这个映射的端口绑定在0.0.0.0的接口上，方法是加上参数-b 0.0.0.0。同时还需要打开SSH服务器端的一个选项－GatewayPorts。默认情况下它应当是被打开的。如果被关闭的话，可以在/etc /sshd_config中修改GatewayPorts no为GatewayPorts yes来打开它。</p> </li> </ul> <hr /> <p>以上参考：</p> <p><a href="http://blog.creke.net/722.html">SSH隧道与端口转发及内网穿透</a></p> <p><a href="http://codelife.me/blog/2012/12/09/three-types-of-ssh-turneling/">三种不同类型的ssh隧道</a></p> <p><a href="https://www.liaohuqiu.net/cn/posts/setup-web-prorxy-by-ssh-tunnel/">简单的ssh隧道实现代理上网</a></p> <p><a href="http://www.cnblogs.com/robinyjj/archive/2008/11/03/1325853.html">SSH Tunnel 实现VPN的功能</a></p> <p><a href="http://www.pchou.info/linux/2015/11/01/ssh-tunnel.html">SSH隧道翻墙的原理和实现</a></p> <p><a href="http://chenweiguang.blogspot.ae/2009/03/ssh.html">SSH 隧道转发实战</a></p> <p><span class="site-footer-credits">版权所有，转载请注明出处 <a href="https://luowei.github.io/list">luowei.github.io</a>.</span></p> <link rel="stylesheet" href="/list/assets/css/font-awesome.min.css?ver=20151122" /> <!--[if IE 7 ]><link rel="stylesheet" href="/list/assets/css/font-awesome-ie7.min.css?ver=20151122"><![endif]--> <div style="float: right"> <span id="share"> <a class="wechat" target="_blank" title="分享到微信" href="https://chart.apis.google.com/chart?cht=qr&amp;chs=300x300&amp;chl=https%3A%2F%2Fluowei.github.io%2Flist%2Fdocs%2Flinux%2F2016-12-13-ssh%25E9%259A%25A7%25E9%2581%2593%25E3%2580%2581%25E7%25AB%25AF%25E5%258F%25A3%25E8%25BD%25AC%25E5%258F%2591%25E5%258F%258A%25E5%2586%2585%25E7%25BD%2591%25E7%25A9%25BF%25E9%2580%258F.html"><i class="icon-large icon-wechat"></i></a> <a class="weibo" target="_blank" title="分享到微博" href="http://service.weibo.com/share/share.php?title=ssh隧道、端口转发及内网穿透 - 知不知&amp;url=https%3A%2F%2Fluowei.github.io%2Flist%2Fdocs%2Flinux%2F2016-12-13-ssh%25E9%259A%25A7%25E9%2581%2593%25E3%2580%2581%25E7%25AB%25AF%25E5%258F%25A3%25E8%25BD%25AC%25E5%258F%2591%25E5%258F%258A%25E5%2586%2585%25E7%25BD%2591%25E7%25A9%25BF%25E9%2580%258F.html&amp;type=3&amp;searchPic=1"><i class="icon-large icon-weibo"></i></a> <a class="qzone" target="_blank" title="分享到 QQ 空间" href="http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https%3A%2F%2Fluowei.github.io%2Flist%2Fdocs%2Flinux%2F2016-12-13-ssh%25E9%259A%25A7%25E9%2581%2593%25E3%2580%2581%25E7%25AB%25AF%25E5%258F%25A3%25E8%25BD%25AC%25E5%258F%2591%25E5%258F%258A%25E5%2586%2585%25E7%25BD%2591%25E7%25A9%25BF%25E9%2580%258F.html&amp;title=ssh隧道、端口转发及内网穿透 - 知不知&amp;summary=ssh隧道、端口转发及内网穿透&amp;site=/list"><i class="icon-large icon-qzone"></i></a> <a class="twitter" target="_blank" title="Share to Twitter" href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fluowei.github.io%2Flist%2Fdocs%2Flinux%2F2016-12-13-ssh%25E9%259A%25A7%25E9%2581%2593%25E3%2580%2581%25E7%25AB%25AF%25E5%258F%25A3%25E8%25BD%25AC%25E5%258F%2591%25E5%258F%258A%25E5%2586%2585%25E7%25BD%2591%25E7%25A9%25BF%25E9%2580%258F.html&amp;text=ssh隧道、端口转发及内网穿透 - 知不知&amp;via=luowei010101"><i class="icon-large icon-twitter"></i></a> <a class="facebook" target="_blank" title="Share to Facebook" href="https://www.facebook.com/sharer.php?u=https%3A%2F%2Fluowei.github.io%2Flist%2Fdocs%2Flinux%2F2016-12-13-ssh%25E9%259A%25A7%25E9%2581%2593%25E3%2580%2581%25E7%25AB%25AF%25E5%258F%25A3%25E8%25BD%25AC%25E5%258F%2591%25E5%258F%258A%25E5%2586%2585%25E7%25BD%2591%25E7%25A9%25BF%25E9%2580%258F.html&amp;t=ssh隧道、端口转发及内网穿透 - 知不知"><i class="icon-large icon-facebook-sign"></i></a> <a class="googleplus" target="_blank" title="Share to Google+" href="https://plus.google.com/share?url=https%3A%2F%2Fluowei.github.io%2Flist%2Fdocs%2Flinux%2F2016-12-13-ssh%25E9%259A%25A7%25E9%2581%2593%25E3%2580%2581%25E7%25AB%25AF%25E5%258F%25A3%25E8%25BD%25AC%25E5%258F%2591%25E5%258F%258A%25E5%2586%2585%25E7%25BD%2591%25E7%25A9%25BF%25E9%2580%258F.html"><i class="icon-large icon-google-plus-sign"></i></a> </span> </div> <hr /> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css" /> <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> <div id="gitalk-container"></div> <script type="text/javascript"> var gitalk = new Gitalk({ clientID: '9d5ee666269c252cf949', clientSecret: '728cd598f1fca9d8c1df1dfa300057883a3a8676', repo: 'list', owner: 'luowei', admin: ['luowei'], id: decodeURI('ssh隧道、端口转发及内网穿透'), distractionFreeMode: false }); gitalk.render('gitalk-container'); </script> <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? "https://" : "http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1277627361'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s96.cnzz.com/z_stat.php%3Fid%3D1277627361%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));</script> <footer class="site-footer"> <span class="site-footer-owner"><a href="https://luowei.github.io/list">知不知</a> is maintained by <a href="http://luowei.github.io/list">luowei</a>.</span> <span class="site-footer-credits">Developed by <a href="https://luowei.github.io/list">luowei</a>.</span> </footer> </section> </body> </html>
