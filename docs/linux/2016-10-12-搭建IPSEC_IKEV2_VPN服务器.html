<!DOCTYPE html> <html lang="en"> <head> <meta charset="UTF-8"> <title>知不知</title> <meta name="viewport" content="width=device-width, initial-scale=1"> <meta name="theme-color" content="#157878"> <meta name="apple-itunes-app" content="app-id=1227288468, app-argument=https://luowei.github.io/list/docs/linux/2016-10-12-%E6%90%AD%E5%BB%BAIPSEC_IKEV2_VPN%E6%9C%8D%E5%8A%A1%E5%99%A8.html"> <link rel="stylesheet" href="/list/assets/css/normalize.css"> <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'> <link rel="stylesheet" href="/list/assets/css/cayman.css"> </head> <body> <section class="page-header"> <h1 class="project-name">知不知</h1> <h2 class="project-tagline"><a style="color:#ffffff;" href="http://luowei.github.io/list">知不知</a> 是一个代码爱好者的技术知识分享部落格。</h2> <a href="http://wodedata.com" target="_blank" class="btn">wodedata</a> <a href="/list" class="btn">home</a> <a href="http://app.wodedata.com" target="_blank" class="btn">APP作品</a> </section> <section class="main-content"> <!-- 标题 --> <h2>搭建IPSEC_IKEV2_VPN服务器</h2> <!-- Google Ads --> <script async="" src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <p><ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-8760692904992206" data-ad-slot="2948937366"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script></p> <p>　　IPsec 是 虚拟私密网络（VPN） 的一种，用于在服务器和客户端之间建立加密隧道并传输敏感数据之用。它由两个阶段组成，第一阶段（Phrase 1, ph1），交换金钥建立连接，使用互联网金钥交换（ike）协议; 第二阶段（Phrase 2, ph2），连接建立后对数据进行加密传输，使用封装安全载荷（esp）协议</p> <h2 id="安装">安装</h2> <ol> <li>安装必须的库 <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum update
yum install pam-devel openssl-devel make gcc
</code></pre></div> </div> </li> <li>下载strongswan并解压 <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget http://download.strongswan.org/strongswan.tar.gz
tar xzf strongswan.tar.gz
cd strongswan-*
</code></pre></div> </div> </li> <li>编译Strongswan <strong>Xen、KVM使用以下参数</strong> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./configure  --enable-eap-identity --enable-eap-md5 \
--enable-eap-mschapv2 --enable-eap-tls --enable-eap-ttls --enable-eap-peap  \
--enable-eap-tnc --enable-eap-dynamic --enable-eap-radius --enable-xauth-eap  \
--enable-xauth-pam  --enable-dhcp  --enable-openssl  --enable-addrblock --enable-unity  \
--enable-certexpire --enable-radattr --enable-tools --enable-openssl --disable-gmp
</code></pre></div> </div> </li> <li>编译并安装 <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make; make install
</code></pre></div> </div> </li> </ol> <h2 id="配置证书">配置证书</h2> <ol> <li>生成CA证书的私钥 <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ipsec pki --gen --outform pem &gt; ca.pem
ipsec pki --gen &gt; caKey.der
</code></pre></div> </div> </li> <li>使用私钥，签名CA证书 <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ipsec pki --self --in ca.pem --dn "C=com, O=wodedata, CN=VPN CA" --ca --outform pem &gt;ca.cert.pem
ipsec pki --self --in caKey.der --dn "C=com, O=wodedata, CN=Wodedata CA" --ca &gt; caCert.der
openssl x509 -inform der -in caCert.der -out caCert.pem
</code></pre></div> </div> </li> <li>生成服务器证书所需的私钥 <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ipsec pki --gen --outform pem &gt; server.pem
ipsec pki --gen &gt; serverKey.der
</code></pre></div> </div> </li> <li>用CA证书签发服务器证书(命令中的”C=”和”O=”的值要与第2步CA中的C,O的值保持一致) <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ipsec pki --pub --in server.pem | ipsec pki --issue --cacert ca.cert.pem --cakey ca.pem --dn "C=com, O=wodedata, CN=my.wodedata.com" --san="my.wodedata.com" --flag serverAuth --flag ikeIntermediate --outform pem &gt; server.cert.pem
ipsec pki --pub --in serverKey.der | ipsec pki --issue --cacert caCert.der --cakey caKey.der --dn "C=com, O=wodedata, CN=my.wodedata.com" --san="my.wodedata.com" &gt; serverCert.der
openssl x509 -inform der -in serverCert.der -out serverCert.pem
openssl rsa -inform der -in serverKey.der -out serverKey.pem
</code></pre></div> </div> </li> <li>生成客户端证书所需的私钥 <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ipsec pki --gen --outform pem &gt; client.pem
ipsec pki --gen &gt; clientKey.der
</code></pre></div> </div> </li> <li>用CA签名客户端证书:(C,O的值要与上面第2步CA的值一致,CN的值随意) <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ipsec pki --pub --in client.pem | ipsec pki --issue --cacert ca.cert.pem --cakey ca.pem --dn "C=com, O=wodedata, CN=VPN Client" --outform pem &gt; client.cert.pem
ipsec pki --pub --in clientKey.der | ipsec pki --issue --cacert caCert.der --cakey caKey.der --dn "C=com, O=wodedata, CN=Wodedata Client" &gt; clientCert.der
openssl x509 -inform der -in clientCert.der -out clientCert.pem
openssl rsa -inform der -in clientKey.der -out clientKey.pem
</code></pre></div> </div> </li> <li>生成pkcs12证书:(命令中的”-caname”后面的引号里的值必须要与第2步CA中的”CN=”的值保持一致) <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># openssl pkcs12 -export -inkey client.pem -in client.cert.pem -name "client" -certfile ca.cert.pem -caname "VPN CA"  -out client.cert.p12
openssl pkcs12 -export -inkey clientKey.pem -in clientCert.pem -name "client" -certfile caCert.pem -caname "Wodedata CA"  -out clientCert.p12
</code></pre></div> </div> </li> <li>安装证书 <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> # cp -r ca.cert.pem /usr/local/etc/ipsec.d/cacerts/
 # cp -r server.cert.pem /usr/local/etc/ipsec.d/certs/
 # cp -r server.pem /usr/local/etc/ipsec.d/private/
 # cp -r client.cert.pem /usr/local/etc/ipsec.d/certs/
 # cp -r client.pem  /usr/local/etc/ipsec.d/private/
	
 cp -r caCert.pem /usr/local/etc/ipsec.d/cacerts/
 cp -r serverCert.pem /usr/local/etc/ipsec.d/certs/
 cp -r serverKey.pem /usr/local/etc/ipsec.d/private/
 cp -r clientCert.pem /usr/local/etc/ipsec.d/certs/
 cp -r clientKey.pem  /usr/local/etc/ipsec.d/private/
</code></pre></div> </div> </li> </ol> <p>** 启动 strongSwan **</p> <ul> <li>启动：<code class="highlighter-rouge">ipsec start</code></li> <li>重新加载配置文件：<code class="highlighter-rouge">ipsec reload</code></li> <li>重新加载用户名密码文件：<code class="highlighter-rouge">ipsec rereadsecrets</code></li> </ul> <h2 id="参考链接">参考链接：</h2> <ul> <li><a href="https://zh.opensuse.org/index.php?title=SDB:Setup_Ipsec_VPN_with_Strongswan&amp;variant=zh">使用 Strongswan 架设 Ipsec VPN（强烈推荐，原理详细）</a></li> <li><a href="https://hjc.im/shi-yong-strongswanda-jian-ipsecikev2-vpn/">使用Strongswan搭建IPSec/IKEv2 VPN</a></li> <li><a href="http://quericy.me/blog/512">UBUNTU、CENTOS搭建IPSEC/IKEV2 VPN服务器全攻略</a></li> <li><a href="http://blog.zorro.im/posts/strongswan-ikev2-for-ios-without-certificate.html">用 strongSwan 搭建免证书的 IKEv2 VPN</a></li> <li><a href="https://maskray.me/blog/2015-12-31-strongswan">支持Android、iOS 9内置IPSec客户端的strongSwan 5.3.5配置</a></li> <li><a href="http://maclue.tumblr.com/post/11947923571/strongswan-ipsec-vpn-for-ios">使用strongSwan搭建IPSec VPN for iOS</a></li> <li><a href="https://medium.com/@cattyhouse/ios-ondemand-ipsec-vpn-setup-ebfb82b6f7a1">iOS Ondemand IPSec VPN Setup</a></li> <li><a href="https://maoxian.de/2014/10/1220.html">Setup IKEv2 On Demand VPN on iOS 8 and IKEv2, IKEv1 Cisco IPSec VPN with Strongswan</a></li> <li><a href="https://ttz.im/2015/10/1335">配置iOS 9的IKEv2 VPN</a></li> </ul> <p><span class="site-footer-credits">版权所有，转载请注明出处 <a href="https://luowei.github.io/list">luowei.github.io</a>.</span></p> <link rel="stylesheet" href="/list/assets/css/font-awesome.min.css?ver=20151122" /> <!--[if IE 7 ]><link rel="stylesheet" href="/list/assets/css/font-awesome-ie7.min.css?ver=20151122"><![endif]--> <div style="float: right"> <span id="share"> <a class="wechat" target="_blank" title="分享到微信" href="https://chart.apis.google.com/chart?cht=qr&amp;chs=300x300&amp;chl=https%3A%2F%2Fluowei.github.io%2Flist%2Fdocs%2Flinux%2F2016-10-12-%25E6%2590%25AD%25E5%25BB%25BAIPSEC_IKEV2_VPN%25E6%259C%258D%25E5%258A%25A1%25E5%2599%25A8.html"><i class="icon-large icon-wechat"></i></a> <a class="weibo" target="_blank" title="分享到微博" href="http://service.weibo.com/share/share.php?title=搭建IPSEC_IKEV2_VPN服务器 - 知不知&amp;url=https%3A%2F%2Fluowei.github.io%2Flist%2Fdocs%2Flinux%2F2016-10-12-%25E6%2590%25AD%25E5%25BB%25BAIPSEC_IKEV2_VPN%25E6%259C%258D%25E5%258A%25A1%25E5%2599%25A8.html&amp;type=3&amp;searchPic=1"><i class="icon-large icon-weibo"></i></a> <a class="qzone" target="_blank" title="分享到 QQ 空间" href="http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https%3A%2F%2Fluowei.github.io%2Flist%2Fdocs%2Flinux%2F2016-10-12-%25E6%2590%25AD%25E5%25BB%25BAIPSEC_IKEV2_VPN%25E6%259C%258D%25E5%258A%25A1%25E5%2599%25A8.html&amp;title=搭建IPSEC_IKEV2_VPN服务器 - 知不知&amp;summary=搭建IPSEC/IKEV2 VPN服务器&amp;site=/list"><i class="icon-large icon-qzone"></i></a> <a class="twitter" target="_blank" title="Share to Twitter" href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fluowei.github.io%2Flist%2Fdocs%2Flinux%2F2016-10-12-%25E6%2590%25AD%25E5%25BB%25BAIPSEC_IKEV2_VPN%25E6%259C%258D%25E5%258A%25A1%25E5%2599%25A8.html&amp;text=搭建IPSEC_IKEV2_VPN服务器 - 知不知&amp;via=luowei010101"><i class="icon-large icon-twitter"></i></a> <a class="facebook" target="_blank" title="Share to Facebook" href="https://www.facebook.com/sharer.php?u=https%3A%2F%2Fluowei.github.io%2Flist%2Fdocs%2Flinux%2F2016-10-12-%25E6%2590%25AD%25E5%25BB%25BAIPSEC_IKEV2_VPN%25E6%259C%258D%25E5%258A%25A1%25E5%2599%25A8.html&amp;t=搭建IPSEC_IKEV2_VPN服务器 - 知不知"><i class="icon-large icon-facebook-sign"></i></a> <a class="googleplus" target="_blank" title="Share to Google+" href="https://plus.google.com/share?url=https%3A%2F%2Fluowei.github.io%2Flist%2Fdocs%2Flinux%2F2016-10-12-%25E6%2590%25AD%25E5%25BB%25BAIPSEC_IKEV2_VPN%25E6%259C%258D%25E5%258A%25A1%25E5%2599%25A8.html"><i class="icon-large icon-google-plus-sign"></i></a> </span> </div> <hr /> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css" /> <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> <div id="gitalk-container"></div> <script type="text/javascript"> var gitalk = new Gitalk({ clientID: '9d5ee666269c252cf949', clientSecret: '728cd598f1fca9d8c1df1dfa300057883a3a8676', repo: 'list', owner: 'luowei', admin: ['luowei'], id: decodeURI('搭建IPSEC_IKEV2_VPN服务器'), distractionFreeMode: false }); gitalk.render('gitalk-container'); </script> <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? "https://" : "http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1277627361'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s96.cnzz.com/z_stat.php%3Fid%3D1277627361%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));</script> <footer class="site-footer"> <span class="site-footer-owner"><a href="https://luowei.github.io/list">知不知</a> is maintained by <a href="http://luowei.github.io/list">luowei</a>.</span> <span class="site-footer-credits">Developed by <a href="https://luowei.github.io">luowei</a>.</span> </footer> </section> </body> </html>
